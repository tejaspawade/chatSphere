@{
    ViewBag.Title = "Chat";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container-fluid vh-100 d-flex flex-column bg-light">
    <div class="row flex-grow-1 mt-4">
        <!-- Left Panel: Online Users -->
        <div class="col-md-3 col-sm-12 mb-3">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-primary text-white fw-semibold">Online Users</div>
                <div class="card-body overflow-auto" id="onlineUsers">
                    <!-- Online users will appear here -->
                </div>
            </div>
        </div>

        <!-- Right Panel: Chat Area -->
        <div class="col-md-9 col-sm-12">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-secondary text-white">
                    <h5 id="chatHeader" class="mb-0">Public Chat</h5>
                </div>

                <div class="card-body d-flex flex-column" style="height: 70vh;">
                    <ul id="messages" class="list-unstyled overflow-auto flex-grow-1 mb-3 bg-white rounded p-3 border"></ul>

                    <div class="input-group">
                        <input id="messageInput" type="text" class="form-control" placeholder="Type a message..." />
                        <button id="sendBtn" class="btn btn-primary">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SignalR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .build();

    const username = "@ViewBag.Username";
    const userId = "@ViewBag.UserId";
    let currentChatUser = null;

    function addMessage(text) {
        const li = document.createElement("li");
        li.textContent = text;
        li.classList.add("p-2", "bg-light", "rounded", "mb-2");
        document.getElementById("messages").appendChild(li);
        li.scrollIntoView({ behavior: "smooth", block: "end" });
    }

    function renderUsers(users) {
        const list = document.getElementById("onlineUsers");
        list.innerHTML = "";
        users.forEach(user => {
            if (user.id === userId) return;
            const div = document.createElement("div");
            div.classList.add("p-2", "rounded", "mb-2", "user-item", "bg-light", "border");
            div.textContent = user.username;
            div.style.cursor = "pointer";
            div.dataset.userid = user.id;

            div.addEventListener("click", async () => {
                currentChatUser = user.id;
                document.getElementById("chatHeader").textContent = `Private Chat with ${user.username}`;
                document.getElementById("messages").innerHTML = "";
                await connection.invoke("LoadPrivateChat", userId, currentChatUser);
            });

            list.appendChild(div);
        });
    }

    connection.on("ReceiveMessage", (user, message, time) => {
        if (!currentChatUser) addMessage(`${time} - ${user}: ${message}`);
    });

    connection.on("ReceivePrivateMessage", (user, message, time) => {
        addMessage(`${time} - ${user}: ${message}`);
    });

    connection.on("LoadPrivateChat", messages => {
        const list = document.getElementById("messages");
        list.innerHTML = "";
        messages.forEach(msg => {
            addMessage(`${msg.timestamp} - ${msg.userName}: ${msg.content}`);
        });
    });

    connection.on("UserConnected", (users) => renderUsers(users));
    connection.on("UserDisconnected", (users) => renderUsers(users));

    document.getElementById("sendBtn").addEventListener("click", async () => {
        const msg = document.getElementById("messageInput").value.trim();
        if (!msg) return;

        if (currentChatUser) {
            await connection.invoke("SendPrivateMessage", userId, currentChatUser, msg);
        } else {
            await connection.invoke("SendMessage", username, msg);
        }

        document.getElementById("messageInput").value = "";
    });

    connection.start();
</script>

